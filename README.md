# W3ProOTA

> W3Pro的OTA项目，采用串口进行升级，基于C的升级代码Demo，用Kotlin重写，在Android层实现。

## 说明

1. 芯片是蓝汛的芯片，采用串口通信进行OTA，需要选择`upd` 作为文件升级的格式。
2. 调试时尽量用USB无线连接手机，因为手机的USB口需要插USB线，没有办法直接debug运行了，无线调试方式：
```
● 首先手机和电脑处于同一个局域网下
● 手机USB数据线连接电脑(确保adb devices命令能够找到你自己的设备)
● 运行命令：adb tcpip 5555
● 拔掉数据线，并且将手机和电脑连接到同一个局域网下，然后找到手机的ip地址（我的手机IP是：192.168.0.73）
● 运行命令 adb connect 192.168.0.73 连接手机
● adb devices 找到自己的无线设备，连接成功
● 拔掉数据线，只保留一个设备，完毕
```

- 串口通信的调试库来自github，为了快速验证，就没自己封装了，链接：https://github.com/licoba/SerialHelper，有需要可以拿源码自己修改


## 流程

1. 首先是建立串口通信
2. 客户端向串口发送 `START_UPD^_^` 指令（注意要把字符串转为16进制再发送）
3. 服务端收到指令后，回复 `RECEIVESTART` 表示已经收到了我们发送的启动升级命令
4. 蓝汛进入升级模式
5. 蓝汛发送数据读取指令，以 `55AA02` 开头，表示可以开始传输升级数据了
6. 客户端首先根据上一条指令，得到数据的 `addr` 也就是起始位置，然后从文件读取 512字节长度的数据，并计算得到**文件校验和**，放到 `data_crc` 字段
7. 客户端根据指令盒文件校验和信息，计算出**命令校验和**，放到 `crc` 字段
8. 按照命令在前、数据在后的规则，先发送升级命令，再发送升级数据包
9. 服务端收并校验到后，会发送一个继续读取数据的指令，以 `55AA02` 开头，这包数据中的 `addr` 会发生改变，表示可以继续传输升级数据
10. 根据更新后的 `addr` 继续取512个字节的文件，循环执步骤 **6+7+8**
11. 期间可能会收到一条确认还在UPD模式指令,以 `55AA01` 开头，收到这个包，原封不动发送给服务端
12. 升级完成，客户端收到升级完成指令，以`55AA03` 开头



## 注意事项
- 在解码时，需要以小端的字节序来解析，发送时也如此
- 同一个文件，不会覆盖升级，蓝汛会很快返回一个升级完成的指令
- 如果同一个版本的固件，升级完成了之后再重新发送`START_UPD^_^` 指令，服务端不会响应
- 可以断点续传，升级终端再开机服务端会直接发送 `55AA02` 的数据，客户端要做的就是根据命令里的起始 `addr` 去取数据就可以了。
- 升级收到成功命令要等待耳机重启（第一阶段），并接收到版本信息后，再次提示告知升级后的版本（确认升级成功），耳机重启都会主动发送一帧开机数据，格式见文档；



## 资料
- 流程文档和C源码都在doc目录下
- 更多详细资料看C源码和Android端的实现源码
